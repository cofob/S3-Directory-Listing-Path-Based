<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Directory Listing</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        /* General */
        body {
            background-color: #1a1a1a;
            color: #f0f0f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        /* Headers */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: #fff;
        }

        /* Links */
        a {
            color: #6dd5ed;
        }

        a:hover {
            color: #46b5d1;
        }

        /* Table */
        .table {
            border-collapse: collapse;
            width: 100%;
        }

        .table thead th {
            background-color: #282828;
            border-bottom: 1px solid #444;
            color: #fff;
            padding: 12px;
            text-align: left;
        }

        .table tbody tr {
            border-bottom: 1px solid #444;
        }

        .table tbody tr:nth-child(even) {
            background-color: #222;
        }

        .table tbody tr:hover {
            background-color: #333;
        }

        .table tbody td {
            padding: 12px;
            color: #888
        }

        /* Breadcrumb */
        .breadcrumb {
            background-color: #1a1a1a;
        }

        .breadcrumb .breadcrumb-item a {
            color: #6dd5ed;
        }

        .breadcrumb .breadcrumb-item a:hover {
            color: #46b5d1;
        }

        .breadcrumb .breadcrumb-item.active {
            color: #f0f0f0;
        }

        /* Alerts */
        .alert-danger {
            background-color: #b71c1c;
            border-color: #b71c1c;
            color: #fff;
        }

        /* Toggle switch */
        .custom-control-label::before {
            border-color: #6c757d;
        }

        .custom-control-input:checked~.custom-control-label::before {
            background-color: #6dd5ed;
            border-color: #6dd5ed;
        }

        /* Copyright */
        .text-muted {
            color: #888 !important;
        }
    </style>
    <link id="dark-mode-style" rel="stylesheet" href="dark-mode.css">
</head>

<body>
    <div class="container">
        <h1 class="my-4">S3 Directory Listing</h1>
        <div class="custom-control custom-switch my-3">
            <input type="checkbox" class="custom-control-input" id="darkModeSwitch">
            <label class="custom-control-label" for="darkModeSwitch">Dark Mode</label>
        </div>
        <nav id="breadcrumb" class="breadcrumb">
        </nav>
        <input class="form-control mb-3" id="search" type="text" placeholder="Search...">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Last Modified</th>
                    <th>Size</th>
                </tr>
            </thead>
            <tbody id="object-list">
            </tbody>
        </table>
        <div id="loading" class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <div id="error" class="alert alert-danger d-none" role="alert">
        </div>

        <div class="mt-4 d-flex justify-content-between">
            <button id="prevPage" class="btn btn-primary" disabled>Previous</button>
            <span id="pageInfo">Page 1</span>
            <button id="nextPage" class="btn btn-primary">Next</button>
        </div>
        <div class="row mt-5">
            <div class="col">
                <p class="text-muted text-center">
                    &copy; 2023 S3 Directory Listing - <a href="https://github.com/flightlesstux/S3-Directory-Listing"
                        target="_blank">S3-Directory-Listing</a>
                </p>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // S3 bucket name
        const bucketName = 's3-directory-listing';
        const s3Domain = 's3.amazonaws.com';

        const objectList = document.getElementById('object-list');
        const breadcrumb = document.getElementById('breadcrumb');
        const searchInput = document.getElementById('search');
        const loading = document.getElementById('loading');
        const errorAlert = document.getElementById('error');
        const itemsPerPage = 10;

        let totalPages = 0;
        let currentPage = 1;
        let currentPath = '';

        function isFolder(key) {
            return key.endsWith('/');
        }

        function createDownloadLink(key) {
            let urlEncodedKey = encodeURIComponent(key)
            const url = `https://${s3Domain}/${bucketName}/${urlEncodedKey}`;
            const link = document.createElement('a');
            link.href = url;

            // Create the icon element
            const icon = document.createElement('i');
            icon.className = isFolder(key) ? 'fas fa-folder mr-2' : 'fas fa-file mr-2';

            // Create the span element to hold the text
            const textSpan = document.createElement('span');

            if (isFolder(key)) {
                textSpan.textContent = key.slice(0, -1).split('/').pop();
            } else {
                textSpan.textContent = key.split('/').pop();
                link.setAttribute('download', '');
            }

            // Append the icon and the text span to the link
            link.appendChild(icon);
            link.appendChild(textSpan);

            return link;
        }


        function navigateTo(path) {
            currentPath = path;
            listObjects(currentPath);
        }

        function updateBreadcrumb(path) {
            const parts = path.split('/').filter((part) => part);
            let crumbPath = '';

            breadcrumb.innerHTML = '<li class="breadcrumb-item"><a href="index.html">Home</a></li>';

            parts.forEach((part, index) => {
                crumbPath += part + '/';
                const listItem = document.createElement('li');
                listItem.className = 'breadcrumb-item';

                if (index === parts.length - 1) {
                    listItem.textContent = part;
                    listItem.classList.add('active');
                } else {
                    const link = document.createElement('a');
                    link.href = crumbPath;
                    link.textContent = part;
                    let thisCrumbPath = crumbPath;
                    link.onclick = (e) => {
                        currentPage = 1
                        e.preventDefault();
                        navigateTo(thisCrumbPath);
                    }
                    listItem.appendChild(link);
                }

                breadcrumb.appendChild(listItem);
            });
        }

        function formatSize(size) {
            if (isNaN(size)) {
                return 'Unknown';
            }

            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let index;

            for (index = 0; size >= 1024 && index < units.length - 1; index++) {
                size /= 1024;
            }

            return `${size.toFixed(2)} ${units[index]}`;
        }

        function listObjects(path) {
            const prefix = path ? `prefix=${path}&` : '';
            const url = `https://${s3Domain}/${bucketName}/?list-type=2&${prefix}delimiter=%2F`;

            loading.classList.remove('d-none');
            errorAlert.classList.add('d-none');

            fetch(url)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`Error fetching objects: ${response.status}`);
                    }
                    return response.text();
                })
                .then((text) => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, 'text/xml');
                    const keys = xmlDoc.getElementsByTagName('Key');
                    const prefixes = xmlDoc.getElementsByTagName('Prefix');

                    // Pagination logic
                    const startIndex = (currentPage - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;

                    // Slice the items based on pagination
                    const displayedPrefixes = Array.from(prefixes).slice(startIndex, endIndex);
                    const displayedKeys = Array.from(keys).slice(startIndex, endIndex - displayedPrefixes.length);
                    let totalItems = prefixes.length + keys.length;
                    totalPages = Math.ceil(totalItems / itemsPerPage);
                    const nextContinuationToken = xmlDoc.querySelector('NextContinuationToken') ? xmlDoc.querySelector('NextContinuationToken').textContent : null;
                    if (nextContinuationToken) {
                        // Enable the "Next" button since there are more items to fetch
                        document.getElementById('nextPage').addEventListener('click', function () {
                            listObjects(currentPath, nextContinuationToken);
                        });
                    } else {
                        document.getElementById('nextPage').disabled = true;
                    }

                    objectList.innerHTML = '';

                    displayedPrefixes.forEach((prefix) => {
                        const key = prefix.textContent;
                        if (key === path) {
                            return;
                        }
                        const row = document.createElement('tr');
                        const nameCell = document.createElement('td');
                        const link = createDownloadLink(key);

                        link.onclick = (e) => {
                            e.preventDefault();
                            navigateTo(key);
                        };

                        nameCell.appendChild(link);
                        row.appendChild(nameCell);
                        row.insertCell(-1).textContent = ''; // Empty cells for last modified and size
                        row.insertCell(-1).textContent = '';
                        objectList.appendChild(row);
                    });

                    displayedKeys.forEach((keyElement) => {
                        const key = keyElement.textContent;
                        if (key === 'index.html' || key === 's3.js' || key === 'dark-mode.css' || key === 'config.js') {
                            return;
                        }
                        if (key === path) {
                            return;
                        }

                        const lastModified = new Date(keyElement.nextElementSibling.textContent);
                        const sizeElement = keyElement.parentNode.querySelector('Size');
                        const size = sizeElement ? parseInt(sizeElement.textContent, 10) : NaN;
                        const row = document.createElement('tr');
                        const nameCell = document.createElement('td');
                        const link = createDownloadLink(key);

                        nameCell.appendChild(link);
                        row.appendChild(nameCell);
                        row.insertCell(-1).textContent = lastModified.toLocaleString();
                        row.insertCell(-1).textContent = formatSize(size);
                        objectList.appendChild(row);
                    });

                    updateBreadcrumb(path);
                    updatePaginationControls();
                    loading.classList.add('d-none');
                    loading.classList.add('d-none');
                })
                .catch((error) => {
                    console.error('Error fetching objects:', error);
                    loading.classList.add('d-none');
                    errorAlert.textContent = `Error fetching objects: ${error.message}`;
                    errorAlert.classList.remove('d-none');
                });
        }

        searchInput.addEventListener('input', (e) => {
            const filter = e.target.value.toLowerCase();
            const rows = objectList.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const nameCell = rows[i].getElementsByTagName('td')[0];
                const name = nameCell.textContent || nameCell.innerText;

                if (name.toLowerCase().indexOf(filter) > -1) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        });

        const darkModeSwitch = document.getElementById('darkModeSwitch');

        darkModeSwitch.addEventListener('change', (e) => {
            const darkModeStyle = document.getElementById('dark-mode-style');
            if (e.target.checked) {
                darkModeStyle.disabled = false;
                localStorage.setItem('darkMode', 'true');
            } else {
                darkModeStyle.disabled = true;
                localStorage.setItem('darkMode', 'false');
            }

        });

        const darkModeStyle = document.getElementById('dark-mode-style');
        if (localStorage.getItem('darkMode') === 'true') {
            darkModeSwitch.checked = true;
            darkModeStyle.disabled = false;
        } else {
            darkModeSwitch.checked = false;
            darkModeStyle.disabled = true;
        }

        navigateTo('');

        // Pagination controls logic
        document.getElementById('prevPage').addEventListener('click', function () {
            currentPage = Math.max(currentPage - 1, 1);
            listObjects(currentPath);
        });

        document.getElementById('nextPage').addEventListener('click', function () {
            currentPage = Math.min(currentPage + 1, totalPages);
            listObjects(currentPath);
        });

        function updatePaginationControls() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }
    </script>
</body>

</html>